(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{377:function(s,e,t){"use strict";t.r(e);var r=t(42),a=Object(r.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"optimizing-dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#optimizing-dockerfile"}},[s._v("#")]),s._v(" Optimizing Dockerfile")]),s._v(" "),t("p",[s._v("上一個練習 "),t("RouterLink",{attrs:{to:"/docs/exercises/exercises-21-docker-build.html"}},[s._v("Docker Build")]),s._v(" 最後產生的 Dockerfile 如下：")],1),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" curl -sS https://getcomposer.org/installer | php")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mv composer.phar /usr/local/bin/composer")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Use only development environment")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" APP_KEY "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"base64:ETwf93f5m2aTbg+YxukR3hEiAHzmvKEi0mt605TkMfU="')])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),t("p",[s._v("事實上，這個 Dockerfile 存一些問題：")]),s._v(" "),t("ul",[t("li",[s._v("建置過程傳入了太多非必要的檔案（指 "),t("code",[s._v("COPY . .")]),s._v("），這會\n"),t("ul",[t("li",[s._v("讓建置時間變久")]),s._v(" "),t("li",[s._v("增加不穩定因素")]),s._v(" "),t("li",[s._v("增加不必要的重覆建置")])])]),s._v(" "),t("li",[t("code",[s._v("ENV")]),s._v(" 使用了機敏資訊（key），代表這會在原始碼裡出現")]),s._v(" "),t("li",[s._v("安裝過程「可能」會有不必要的檔案（指 "),t("code",[s._v("composer install")]),s._v(" 會安裝測試套件）")])]),s._v(" "),t("p",[s._v("因此會需要最佳化 Dockerfile，方向有下列幾個：")]),s._v(" "),t("ul",[t("li",[s._v("減少 build image 的時間，以調整流程為主\n"),t("ul",[t("li",[s._v("也可參考 "),t("a",{attrs:{href:"https://docs.docker.com/engine/reference/builder/#dockerignore-file",target:"_blank",rel:"noopener noreferrer"}},[s._v(".dockerignore"),t("OutboundLink")],1)])])]),s._v(" "),t("li",[s._v("減少 image 空間與 commit，以調整流程為主\n"),t("ul",[t("li",[s._v("也可參考 "),t("a",{attrs:{href:"https://hub.docker.com/_/alpine/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Alpine Linux"),t("OutboundLink")],1),s._v(" 或 "),t("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/multistage-build/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Multi-stage Builds"),t("OutboundLink")],1)])])]),s._v(" "),t("li",[s._v("加強 image 的 SaaS 特性，可參考 "),t("a",{attrs:{href:"https://12factor.net/",target:"_blank",rel:"noopener noreferrer"}},[s._v("The Twelve Factors"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"減少-build-context-的大小"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#減少-build-context-的大小"}},[s._v("#")]),s._v(" 減少 build context 的大小")]),s._v(" "),t("p",[s._v("Build context 是執行 build 一開始，會把檔案傳給 Docker Daemon 準備做 build。")]),s._v(" "),t("p",[s._v("但因為有些檔案跟建置無關，如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v(".vagrant")])])]),s._v(" "),t("p",[s._v("與建置無關很好理解。但有些則會是我們希望它跟 image 無關，如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("vendor")])])]),s._v(" "),t("p",[s._v("比方說，為何我們會希望 host 的 vendor 目錄，會跟 image 無關？舉個例子，若 host 的 PHP 版本是 7.3，image 是 7.1 的時候，就很有可能會出問題。如 host 的 PHP 7.3 可能會安裝 PHPUnit 8，但 image PHP 7.1 是不能使用的。")]),s._v(" "),t("p",[s._v("這時，我們可以使用 "),t("code",[s._v(".dockerignore")]),s._v(" 來排除 build context 時的檔案。")]),s._v(" "),t("blockquote",[t("p",[s._v("用法類似 "),t("code",[s._v(".gitignore")]),s._v("。")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(".vagrant\nvendor\nbootstrap/cache/packages.php\nbootstrap/cache/services.php\n")])])]),t("p",[s._v("如此一來，建置速度會加快，且某些內容也比較不會受到 host 檔案影響。")]),s._v(" "),t("h2",{attrs:{id:"利用-cache-來減少不必要的重覆建置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#利用-cache-來減少不必要的重覆建置"}},[s._v("#")]),s._v(" 利用 cache 來減少不必要的重覆建置")]),s._v(" "),t("blockquote",[t("p",[s._v("在一個指令完成 commit 後，只要下一次遇到在同個 parent，同個 commit 時，就會繼續使用同一個 commit（類似 Git 的 fast forward）。建置過程如果有使用同一個 commit 則會顯示 "),t("em",[s._v("Using cache")]),s._v(" 的訊息，因此以下會使用 "),t("em",[s._v("cache")]),s._v(" 來描述這個行為。")]),s._v(" "),t("p",[s._v("如果不希望使用 cache 的話，則可以在 "),t("code",[s._v("docker build")]),s._v(" 指令帶入 "),t("code",[s._v("--no-cache")]),s._v(" 參數即可。")])]),s._v(" "),t("p",[s._v("在執行 "),t("code",[s._v("COPY . .")]),s._v(" 時，要出現 Using cache 的額外條件是：來源內容必須要跟 cache 的一樣（Docker 應該有使用類似 md5 演算法，但不確定用了什麼），才會使用 cache。")]),s._v(" "),t("p",[s._v("這代表，僅僅只是修改 "),t("code",[s._v("README.md")]),s._v(" 就會造成 "),t("code",[s._v("COPY . .")]),s._v(" 重跑，進而讓 "),t("code",[s._v("RUN composer install")]),s._v(" 也重跑。")]),s._v(" "),t("p",[s._v("這問題的思考方向是：了解 "),t("code",[s._v("composer install")]),s._v(" 的依賴為哪些檔案，先把這些檔案複製進 image 後，再執行 "),t("code",[s._v("COPY . .")]),s._v("。")]),s._v(" "),t("p",[s._v("因此解決方法，原本的寫法如下：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n")])])]),t("p",[s._v("改成：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n")])])]),t("p",[s._v("但因為 Laravel 架構設計，所以 "),t("code",[s._v("composer install")]),s._v(" 無法獨立執行，必須加上一點東西：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir -p database/seeds")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir -p database/factories")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install --no-scripts")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n")])])]),t("h2",{attrs:{id:"env-改執行階段傳入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#env-改執行階段傳入"}},[s._v("#")]),s._v(" ENV 改執行階段傳入")]),s._v(" "),t("p",[t("RouterLink",{attrs:{to:"/docs/exercises/exercises-11-environment-variable.html"}},[s._v("Environment")]),s._v(" 練習可以傳入指定的環境變數。而 Laravel 使用 "),t("code",[s._v(".env")]),s._v(" 檔載入環境變數，若要改成由執行階段傳入的話，首先得先把 "),t("code",[s._v(".env")]),s._v(" 忽略：")],1),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# .dockerignore\n.env\n")])])]),t("p",[s._v("接著使用 "),t("code",[s._v("docker run")]),s._v(" 的另一個參數 "),t("code",[s._v("--env-file")]),s._v(" 來載入環境變數：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run --env-file .env laravel\n")])])]),t("p",[s._v("最後即可把 Dockerfile 的環境變數移除。")]),s._v(" "),t("h2",{attrs:{id:"精簡-aufs-的-commit-數"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#精簡-aufs-的-commit-數"}},[s._v("#")]),s._v(" 精簡 AUFS 的 commit 數")]),s._v(" "),t("p",[s._v("Docker 的 commit 數量是有限制的，為 127 個，這是精簡的理由之一。另一個更重大的理由是：因為 AUFS 系統特性，只要 commit 數越多，檔案系統的操作就會越慢，因此更需要想辦法來減少 commit 數。")]),s._v(" "),t("p",[s._v("以本例來說，把最上面安裝 composer 的過程合併，不失為一個好方法：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        curl -sS https://getcomposer.org/installer | php && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mv composer.phar /usr/local/bin/composer")]),s._v("\n")])])]),t("h2",{attrs:{id:"最佳化後的-dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最佳化後的-dockerfile"}},[s._v("#")]),s._v(" 最佳化後的 Dockerfile")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        curl -sS https://getcomposer.org/installer | php && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mv composer.phar /usr/local/bin/composer")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mkdir -p database/seeds && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mkdir -p database/factories && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        composer install --no-scripts")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),t("h2",{attrs:{id:"references"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[s._v("#")]),s._v(" References")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://stackify.com/docker-performance-improvement-tips-and-tricks/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Performance Improvement: Tips and Tricks"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://docs.docker.com/storage/storagedriver/aufs-driver/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Use the AUFS storage driver"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://coolshell.cn/articles/17061.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("DOCKER基础技术：AUFS"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=a.exports}}]);