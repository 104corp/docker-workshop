(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{378:function(s,t,r){"use strict";r.r(t);var n=r(42),a=Object(n.a)({},(function(){var s=this,t=s.$createElement,r=s._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[r("h1",{attrs:{id:"multi-stage-build"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#multi-stage-build"}},[s._v("#")]),s._v(" Multi-stage Build")]),s._v(" "),r("p",[s._v("上一個練習 "),r("RouterLink",{attrs:{to:"/docs/exercises/exercises-22-optimizing-dockerfile.html"}},[s._v("Optimizing Dockerfile")]),s._v(" 最後產生的 Dockerfile 如下：")],1),s._v(" "),r("div",{staticClass:"language-dockerfile extra-class"},[r("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[r("code",[r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        curl -sS https://getcomposer.org/installer | php && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mv composer.phar /usr/local/bin/composer")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mkdir -p database/seeds && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mkdir -p database/factories && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        composer install --no-scripts")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),r("p",[s._v("這裡還有兩個很難解決的問題")]),s._v(" "),r("ul",[r("li",[s._v("Laravel 有使用 npm 套件建置前端程式，但環境只有 PHP，該怎麼辦？")]),s._v(" "),r("li",[s._v("最終建置出來的 Dockerfile，並不希望有任何開發或建置工具（如 Composer），該怎麼辦？")])]),s._v(" "),r("p",[s._v("這兩個問題，可以使用 Multi-stage Build 解決")]),s._v(" "),r("h2",{attrs:{id:"移出-composer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#移出-composer"}},[s._v("#")]),s._v(" 移出 Composer")]),s._v(" "),r("p",[s._v("參考官方文件，可以改寫成這樣：")]),s._v(" "),r("div",{staticClass:"language-dockerfile extra-class"},[r("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[r("code",[r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" php_builder")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        curl -sS https://getcomposer.org/installer | php && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mv composer.phar /usr/local/bin/composer")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir -p database/seeds")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir -p database/factories")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install --no-dev --no-scripts")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token options"}},[r("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("php_builder")])]),s._v(" /source/vendor ./vendor ")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),r("p",[s._v("也因為分成不同階段建構，甚至第一階段的 Composer 安裝還能改寫成如下：")]),s._v(" "),r("div",{staticClass:"language-dockerfile extra-class"},[r("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[r("code",[r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install --no-scripts")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" php vendor/bin/phpunit")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install --no-dev")]),s._v("\n")])])]),r("h2",{attrs:{id:"加入-npm"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#加入-npm"}},[s._v("#")]),s._v(" 加入 npm")]),s._v(" "),r("p",[s._v("對有多階段的做法來說，只要加一個建置階段是 Node 環境即可：")]),s._v(" "),r("div",{staticClass:"language-dockerfile extra-class"},[r("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[r("code",[r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" php_builder")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set -xe && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        curl -sS https://getcomposer.org/installer | php && "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        mv composer.phar /usr/local/bin/composer")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir -p database/seeds")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir -p database/factories")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install --no-scripts")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" php vendor/bin/phpunit")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install --no-dev")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:10.15-alpine "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" npm_builder")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run production")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token options"}},[r("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("php_builder")])]),s._v(" /source/vendor ./vendor")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token options"}},[r("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("npm_builder")])]),s._v(" /source/public/js ./public/js")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token options"}},[r("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("npm_builder")])]),s._v(" /source/public/css ./public/css")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token options"}},[r("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("npm_builder")])]),s._v(" /source/public/mix-manifest.json ./public")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),r("span",{pre:!0,attrs:{class:"token instruction"}},[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),r("p",[s._v("同時這也是最終的結果。")]),s._v(" "),r("h2",{attrs:{id:"references"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[s._v("#")]),s._v(" References")]),s._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/multistage-build/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Use multi-stage builds"),r("OutboundLink")],1)])]),s._v(" "),r("p",[s._v("其他最佳化後的 Dockerfile 範例參考：")]),s._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"https://github.com/MilesChou/docker-phalcon",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Phalcon"),r("OutboundLink")],1)]),s._v(" "),r("li",[r("a",{attrs:{href:"https://github.com/MilesChou/docker-xdebug",target:"_blank",rel:"noopener noreferrer"}},[s._v("PHP with XDebug"),r("OutboundLink")],1)]),s._v(" "),r("li",[r("a",{attrs:{href:"https://github.com/104corp/docker-php-testing",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Image with PHP extensions"),r("OutboundLink")],1)]),s._v(" "),r("li",[r("a",{attrs:{href:"https://github.com/104corp/laravel-eloquent-generator",target:"_blank",rel:"noopener noreferrer"}},[s._v("Laravel Eloquent Generator"),r("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=a.exports}}]);