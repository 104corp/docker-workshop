(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{376:function(s,t,a){"use strict";a.r(t);var e=a(42),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"docker-build"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-build"}},[s._v("#")]),s._v(" Docker Build")]),s._v(" "),a("p",[s._v("練習的過程會不斷的建置與移除，可以先準備好 "),a("a",{attrs:{href:"https://gist.github.com/MilesChou/c278f180b2c14af44bc752cdb437ab24",target:"_blank",rel:"noopener noreferrer"}},[s._v("Makefile"),a("OutboundLink")],1),s._v("，下指令會比較簡單。")]),s._v(" "),a("div",{staticClass:"language-makefile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/usr/bin/make -f")]),s._v("\nIMAGE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("shell")]),s._v(" basename "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("shell")]),s._v(" pwd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nVERSION "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" latest\n\n"),a("span",{pre:!0,attrs:{class:"token builtin-target builtin"}},[s._v(".PHONY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" all build rebuild shell run\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ------------------------------------------------------------------------------")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" build\n\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\tdocker build -t"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" .\n\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("rebuild")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\tdocker build -t"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" --no-cache .\n\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("\tdocker run --rm -it "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),s._v("(IMAGE)")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" sh\n\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("\tdocker run --rm -it "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),s._v("(IMAGE)")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("寫一個 Dockerfile 的順序如下：")]),s._v(" "),a("ol",[a("li",[s._v("準備一個可以成功 build 的 Dockerfile")]),s._v(" "),a("li",[s._v("撰寫 Dockerfile 三循環\n"),a("ol",[a("li",[s._v("新增 Dockerfile 指令")]),s._v(" "),a("li",[s._v("執行 Build，驗證是否正確")]),s._v(" "),a("li",[a("RouterLink",{attrs:{to:"/docs/exercises/exercises-22-optimizing-dockerfile.html"}},[s._v("最佳化 Dockerfile")])],1)])])]),s._v(" "),a("p",[s._v("以下會用上面的方法，來描述如何使用 PHP built-in server，來寫一個 Laravel Skeleton 的 Dockerfile。")]),s._v(" "),a("h2",{attrs:{id:"workshop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#workshop"}},[s._v("#")]),s._v(" Workshop")]),s._v(" "),a("p",[s._v("什麼是一定會成功執行的 Dockerfile？只要 "),a("code",[s._v("FROM")]),s._v(" 存在的 image 即可。"),a("a",{attrs:{href:"https://github.com/laravel/laravel",target:"_blank",rel:"noopener noreferrer"}},[s._v("Laravel 5.8"),a("OutboundLink")],1),s._v(" 系統環境要求是 PHP 7.1+，因此來使用目前最新的穩定版 PHP 7.3。")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n")])])]),a("p",[s._v("接著可以使用 "),a("code",[s._v("docker build")]),s._v(" 與 "),a("code",[s._v("docker run")]),s._v(" 確定該 image 是可以正常執行，且內容是如我們所想的")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("make build\nmake shell\n")])])]),a("h2",{attrs:{id:"調整路徑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#調整路徑"}},[s._v("#")]),s._v(" 調整路徑")]),s._v(" "),a("p",[s._v("一開始這個路徑可能不是我們所想要，所以調整如下：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n")])])]),a("p",[a("code",[s._v("WORKDIR")]),s._v(" 是設定預設工作目錄，也就是 Docker Build，或是 "),a("RouterLink",{attrs:{to:"/docs/exercises/exercises-04-run-command.html"}},[s._v("Run Command")]),s._v(" 的預設工作目錄")],1),s._v(" "),a("h2",{attrs:{id:"安裝-composer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝-composer"}},[s._v("#")]),s._v(" 安裝 Composer")]),s._v(" "),a("p",[s._v("PHP 主要使用 Composer 管理套件依賴。查到安裝 composer 的方法如下：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" curl -sS https://getcomposer.org/installer | php")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mv composer.phar /usr/local/bin/composer")]),s._v("\n")])])]),a("p",[a("code",[s._v("RUN")]),s._v(" 為執行指令，其實就是 "),a("code",[s._v("docker run")]),s._v("，與 "),a("RouterLink",{attrs:{to:"/docs/exercises/exercises-04-run-command.html"}},[s._v("Run Command")]),s._v(" 的效果是一樣的。不過 build 會把執行完的結果 commit 成另一個 image。")],1),s._v(" "),a("h2",{attrs:{id:"安裝依賴套件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝依賴套件"}},[s._v("#")]),s._v(" 安裝依賴套件")]),s._v(" "),a("p",[s._v("接著把程式碼放進 Image 並執行安裝依賴套件的指令 "),a("code",[s._v("composer install")])]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n")])])]),a("p",[a("code",[s._v("COPY")]),s._v(" 是把本機的檔案複製到 image 裡，使用方法為："),a("code",[s._v("COPY [hostPath] [containerPath]")]),s._v("。")]),s._v(" "),a("p",[s._v("要注意這裡有個雷，檔案複製是沒什麼問題的，但目錄的複製就得小心：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" somefile /container/path")]),s._v("\n")])])]),a("p",[s._v("這個結果預期會是，container 會多一個檔案是 "),a("code",[s._v("/container/path/somefile")]),s._v("，結果也如預期。但目錄就不是這樣：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" somedir /container/path")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" somedir/* /container/path")]),s._v("\n")])])]),a("p",[s._v("上面兩個指令是等價的，也就是原本預期會多一個 "),a("code",[s._v("/container/path/somedir")]),s._v(" 目錄，結果卻是 "),a("code",[s._v("somedir")]),s._v(" 目錄裡面的所有東西全複製到 "),a("code",[s._v("/container/path")]),s._v(" 下")]),s._v(" "),a("p",[s._v("解決方法是改成下面這個指令：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" somedir /container/path/somedir")]),s._v("\n")])])]),a("h2",{attrs:{id:"設定預設啟動-server-的指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#設定預設啟動-server-的指令"}},[s._v("#")]),s._v(" 設定預設啟動 server 的指令")]),s._v(" "),a("p",[s._v("使用 Artisan 可以啟動 server，指令如下：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),a("p",[s._v("但執行的時候可能會發現某些問題，如必要的環境變數 "),a("code",[s._v("APP_KEY")]),s._v(" 沒有設定，於是設定給它：")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" APP_KEY "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"base64:ETwf93f5m2aTbg+YxukR3hEiAHzmvKEi0mt605TkMfU="')])]),s._v("\n")])])]),a("p",[s._v("最後重新建置並執行，即可正常運作。")]),s._v(" "),a("h2",{attrs:{id:"設定-expose-資訊"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#設定-expose-資訊"}},[s._v("#")]),s._v(" 設定 EXPOSE 資訊")]),s._v(" "),a("p",[a("code",[s._v("EXPOSE")]),s._v(" 資訊指的是此服務，開放給外部服務的 port 為何，這是 image 上的 metadata。這能提供開發人員或維運人員有效的資訊，包括某些指令也會使用到此 metadata。")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n")])])]),a("h2",{attrs:{id:"dockerfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile"}},[s._v("#")]),s._v(" Dockerfile")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php:7.3-alpine")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" curl -sS https://getcomposer.org/installer | php")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mv composer.phar /usr/local/bin/composer")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" APP_KEY "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"base64:ETwf93f5m2aTbg+YxukR3hEiAHzmvKEi0mt605TkMfU="')])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),s._v("]")]),s._v("\n")])])]),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[s._v("#")]),s._v(" References")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.google.com/presentation/d/1OrcP6FKFpLwmzPhmFH8-O9SHJEyu-_K69tPw2gqqsHs",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Build"),a("OutboundLink")],1),s._v(" | Miles")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10186279",target:"_blank",rel:"noopener noreferrer"}},[s._v("管理貨櫃的碼頭工人－－ Docker （ 2/3 ）"),a("OutboundLink")],1),s._v(" | CI 從入門到入坑")])])])}),[],!1,null,null,null);t.default=r.exports}}]);